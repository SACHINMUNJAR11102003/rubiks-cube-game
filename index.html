<!DOCTYPE html>
<html>
<head>
    <title>Rubik's Cube Game</title>
    <style>
        body { margin: 0; overflow: hidden; background: #000; font-family: Arial; }

        /* LOADING SCREEN */
        #loadingScreen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: black; display: flex; align-items: center; justify-content: center;
            flex-direction: column; color: white; font-size: 22px; z-index: 9999;
        }
        .loader {
            border: 8px solid #333; border-top: 8px solid #00ffea;
            border-radius: 50%; width: 70px; height: 70px;
            animation: spin 1s linear infinite; margin-bottom: 15px;
        }
        @keyframes spin { 0% { transform: rotate(0); } 100% { transform: rotate(360deg); } }

        /* PLAY BUTTON OVERLAY */
        #playOverlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); display: none;
            align-items: center; justify-content: center; flex-direction: column;
            z-index: 9998;
        }
        #playBtn {
            padding: 15px 40px; background: #00ffea; color: black;
            border: none; border-radius: 10px; font-size: 26px; font-weight: bold;
            cursor: pointer; transition: 0.3s;
        }
        #playBtn:hover { background: #00b8a3; }

        /* GAME INFO UI PANEL */
        #infoPanel {
            position: absolute; top: 10px; left: 10px;
            background: rgba(0,0,0,0.6); padding: 15px 20px; border-radius: 12px;
            color: white; font-size: 18px; backdrop-filter: blur(5px);
            border: 1px solid #00ffea; box-shadow: 0 0 15px #00ffea;
            opacity: 0; transition: opacity 1s;
        }
        #infoPanel.visible { opacity: 1; }

        /* BUTTONS PANEL */
        #controls {
            position: absolute; top: 10px; right: 10px;
            background: rgba(0,0,0,0.6); padding: 15px 20px; border-radius: 12px;
            color: white; font-size: 16px; backdrop-filter: blur(5px);
            border: 1px solid #00ffea; box-shadow: 0 0 15px #00ffea;
        }
        #controls button { margin: 3px; padding: 5px 10px; cursor: pointer; }
    </style>
</head>
<body>

<!-- LOADING SCREEN -->
<div id="loadingScreen">
    <div class="loader"></div>
    Loading Game...
</div>

<!-- PLAY BUTTON SCREEN -->
<div id="playOverlay">
    <button id="playBtn">PLAY</button>
</div>

<!-- INFO PANEL -->
<div id="infoPanel">
    <div id="level">Level:</div>
    <div id="scramble">Scramble:</div>
    <div id="required">Required moves:</div>
</div>

<!-- CONTROLS -->
<div id="controls">
    <h3>Rotate Cube Faces</h3>
    <button onclick="rotateCubeFace('U','CW')">U ⟳</button>
    <button onclick="rotateCubeFace('U','CCW')">U ⟲</button>
    <button onclick="rotateCubeFace('D','CW')">D ⟳</button>
    <button onclick="rotateCubeFace('D','CCW')">D ⟲</button>
    <button onclick="rotateCubeFace('L','CW')">L ⟳</button>
    <button onclick="rotateCubeFace('L','CCW')">L ⟲</button>
    <button onclick="rotateCubeFace('R','CW')">R ⟳</button>
    <button onclick="rotateCubeFace('R','CCW')">R ⟲</button>
    <button onclick="rotateCubeFace('F','CW')">F ⟳</button>
    <button onclick="rotateCubeFace('F','CCW')">F ⟲</button>
    <button onclick="rotateCubeFace('B','CW')">B ⟳</button>
    <button onclick="rotateCubeFace('B','CCW')">B ⟲</button>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>

<script>
let scene, camera, renderer, cubeGroup;
let currentState = null;

// Helper: map color chars to hex
function colorToHex(c){
    if (c.includes("w")) return 0xffffff;
    if (c.includes("y")) return 0xffff00;
    if (c.includes("r")) return 0xff0000;
    if (c.includes("o")) return 0xffa500;
    if (c.includes("b")) return 0x0000ff;
    if (c.includes("g")) return 0x00ff00;
    return 0x000000;
}

// ------------------- Load New Game -------------------
async function loadNewGame() {
    const r = await fetch("/new_game");
    const data = await r.json();

    document.getElementById("level").innerText = "Level: " + data.level;
    document.getElementById("scramble").innerText = "Scramble: " + data.scramble;
    document.getElementById("required").innerText = "Required moves: " + data.required_moves;

    currentState = data.state;
    buildCube();
}

// ------------------- Build Cube -------------------
function buildCube() {
    if (cubeGroup) scene.remove(cubeGroup);
    cubeGroup = new THREE.Group();

    const cubieSize = 0.95;
    const gap = 0.05;
    const stickerSize = 0.9;
    const positions = [-1, 0, 1];

    for (let x of positions) {
        for (let y of positions) {
            for (let z of positions) {
                let cubie = new THREE.Group();

                // main cubie cube
                let geom = new THREE.BoxGeometry(cubieSize, cubieSize, cubieSize);
                let materials = [];
                for (let f=0; f<6; f++) materials.push(new THREE.MeshBasicMaterial({color:0x000000}));
                let cubeMesh = new THREE.Mesh(geom, materials);
                cubie.add(cubeMesh);

                // add stickers on outer faces based on currentState
                const faces = ["U","D","F","B","R","L"];
                const dirs = [[0,1,0],[0,-1,0],[0,0,1],[0,0,-1],[1,0,0],[-1,0,0]];
                for (let f=0; f<6; f++){
                    let face = faces[f];
                    let dir = dirs[f];

                    if ((dir[0] && x!==dir[0]) || (dir[1] && y!==dir[1]) || (dir[2] && z!==dir[2])) continue;

                    let idx;
                    if(face==="U") idx = (1-z)*3 + (x+1);
                    if(face==="D") idx = (z+1)*3 + (x+1);
                    if(face==="F") idx = (1-y)*3 + (x+1);
                    if(face==="B") idx = (1-y)*3 + (1-x);
                    if(face==="R") idx = (1-y)*3 + (1-z);
                    if(face==="L") idx = (1-y)*3 + (z+1);

                    let stickerColor = colorToHex(currentState[face][idx]);

                    let stickerGeom = new THREE.PlaneGeometry(stickerSize, stickerSize);
                    let stickerMat = new THREE.MeshBasicMaterial({color: stickerColor, side: THREE.DoubleSide});
                    let sticker = new THREE.Mesh(stickerGeom, stickerMat);

                    sticker.position.set(dir[0]*0.5, dir[1]*0.5, dir[2]*0.5);
                    if (dir[0]!==0) sticker.rotation.y = Math.PI/2;
                    if (dir[1]!==0) sticker.rotation.x = -Math.PI/2;
                    if (dir[2]!==0) sticker.rotation.y = 0;

                    cubie.add(sticker);
                }

                cubie.position.set(x*(cubieSize+gap), y*(cubieSize+gap), z*(cubieSize+gap));
                cubeGroup.add(cubie);
            }
        }
    }

    scene.add(cubeGroup);
}

// ------------------- Init 3D -------------------
function init3D(){
    scene = new THREE.Scene();
    camera = new THREE.PerspectiveCamera(45, window.innerWidth/window.innerHeight, 0.1, 1000);
    camera.position.set(6,6,6); camera.lookAt(0,0,0);
    renderer = new THREE.WebGLRenderer(); renderer.setSize(window.innerWidth,window.innerHeight);
    document.body.appendChild(renderer.domElement);

    let isDragging=false, prevX, prevY;
    renderer.domElement.addEventListener("mousedown", e=>{isDragging=true; prevX=e.clientX; prevY=e.clientY;});
    renderer.domElement.addEventListener("mousemove", e=>{
        if (!isDragging) return;
        let dx=e.clientX-prevX, dy=e.clientY-prevY;
        cubeGroup.rotation.y += dx*0.01; cubeGroup.rotation.x += dy*0.01;
        prevX=e.clientX; prevY=e.clientY;
    });
    window.addEventListener("mouseup", ()=>isDragging=false);

    requestAnimationFrame(function animate(){
        renderer.render(scene, camera);
        requestAnimationFrame(animate);
    });
}

// ------------------- Rotate Cube Face (Button Handler) -------------------
function rotateCubeFace(face, direction){
    // placeholder: simple rotation of whole cube
    let angle = (direction==='CW') ? Math.PI/2 : -Math.PI/2;
    if(face==='U' || face==='D') cubeGroup.rotation.x += angle;
    if(face==='L' || face==='R') cubeGroup.rotation.y += angle;
    if(face==='F' || face==='B') cubeGroup.rotation.z += angle;
}

// ------------------- Start Button -------------------
document.addEventListener("DOMContentLoaded",()=>{
    setTimeout(()=>{
        document.getElementById("loadingScreen").style.display="none";
        document.getElementById("playOverlay").style.display="flex";
    },1200);
});

document.getElementById("playBtn").onclick=()=>{
    document.getElementById("playOverlay").style.display="none";
    document.getElementById("infoPanel").classList.add("visible");
    init3D(); loadNewGame();
};
</script>
</body>
</html>
